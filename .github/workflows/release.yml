name: Release
on:
  workflow_dispatch:
  repository_dispatch:
env:
  DEBIAN_FRONTEND: noninteractive
  TEMPORARY_DIRECTORY: /home/runner/work/_temp
jobs:
  build:
    name: Build multiarch images
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          ref: main
      - name: Checkout Telerising
        uses: actions/checkout@v3
        with:
          repository: telerising/zattoo_api
          ref: ${{ github.event.client_payload.hash }}
          path: telerising
          ssh-key: ${{ secrets.PRIVATE_KEY }}
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      - name: Authenticate registry
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_HUB_USER }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}
      - name: Build image
        run: |
          echo "${github.event.client_payload.hash}"
          echo "${github.event.client_payload.tag}"
          exit 0;
          DOCKER_TAG_HASH="${github.event.client_payload.hash}-$(date +'%Y%m%d-%H%M%S')"
          DOCKER_TAG_VERSION="${github.event.client_payload.tag}"
          DOCKER_TAG_LATEST="latest"

          docker buildx build --platform linux/amd64,linux/arm64,linux/arm/v7 --compress --no-cache --force-rm --push -t qoopido/telerising.minimal:${DOCKER_TAG_HASH} -t qoopido/telerising.minimal:${DOCKER_TAG_VERSION} -t qoopido/telerising.minimal:${DOCKER_TAG_LATEST} .
